# Example Dockerfile for Transaction Validator Application
# This is a reference implementation - adapt to your application needs

# ============================================================================
# Build Stage
# ============================================================================
FROM node:18-alpine AS builder

WORKDIR /app

# Install dependencies for native modules
RUN apk add --no-cache \
    python3 \
    make \
    g++

# Copy package files
COPY package.json package-lock.json ./

# Install dependencies (including devDependencies for build)
RUN npm ci --only=production && \
    npm cache clean --force

# Copy application source
COPY . .

# Build application (if using TypeScript or build step)
# RUN npm run build

# ============================================================================
# Production Stage
# ============================================================================
FROM node:18-alpine

LABEL maintainer="devops@example.com" \
      app="transaction-validator" \
      version="1.0.0"

# Install dumb-init for proper signal handling
RUN apk add --no-cache dumb-init

# Create non-root user
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

WORKDIR /app

# Copy dependencies from builder
COPY --from=builder --chown=appuser:appuser /app/node_modules ./node_modules

# Copy application code
COPY --chown=appuser:appuser . .

# Create directories with correct permissions
RUN mkdir -p /app/logs /app/tmp && \
    chown -R appuser:appuser /app

# Switch to non-root user
USER appuser

# Expose application port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
    CMD node healthcheck.js || exit 1

# Use dumb-init to handle signals properly
ENTRYPOINT ["dumb-init", "--"]

# Start application
CMD ["node", "server.js"]

# ============================================================================
# Alternative: Python Application
# ============================================================================

# FROM python:3.11-slim AS builder
#
# WORKDIR /app
#
# # Install build dependencies
# RUN apt-get update && \
#     apt-get install -y --no-install-recommends \
#     build-essential \
#     && rm -rf /var/lib/apt/lists/*
#
# # Copy requirements and install dependencies
# COPY requirements.txt .
# RUN pip install --user --no-cache-dir -r requirements.txt
#
# # Production stage
# FROM python:3.11-slim
#
# WORKDIR /app
#
# # Create non-root user
# RUN groupadd -r -g 1000 appuser && \
#     useradd -r -u 1000 -g appuser appuser
#
# # Copy dependencies from builder
# COPY --from=builder --chown=appuser:appuser /root/.local /home/appuser/.local
#
# # Copy application
# COPY --chown=appuser:appuser . .
#
# # Make sure scripts are executable
# RUN chmod +x /app/*.sh
#
# USER appuser
#
# ENV PATH=/home/appuser/.local/bin:$PATH
#
# EXPOSE 8080
#
# HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
#     CMD python healthcheck.py || exit 1
#
# CMD ["gunicorn", "--bind", "0.0.0.0:8080", "--workers", "4", "app:app"]

# ============================================================================
# Security Best Practices
# ============================================================================
# ✅ Multi-stage build to reduce image size
# ✅ Non-root user (UID 1000)
# ✅ Minimal base image (Alpine)
# ✅ No unnecessary packages
# ✅ Proper signal handling (dumb-init)
# ✅ Health check included
# ✅ Proper file permissions
# ✅ Layer caching optimized
# ✅ Security scanning with Trivy in CI/CD
# ✅ Metadata labels

# ============================================================================
# Build and Run
# ============================================================================
# Build:
#   docker build -t transaction-validator:1.0.0 .
#
# Run locally:
#   docker run -p 8080:8080 \
#     -e DATABASE_URL="postgresql://..." \
#     -e REDIS_ENDPOINT="redis://..." \
#     transaction-validator:1.0.0
#
# Security scan:
#   trivy image transaction-validator:1.0.0
#
# Push to ECR:
#   aws ecr get-login-password --region us-east-1 | \
#     docker login --username AWS --password-stdin ACCOUNT.dkr.ecr.us-east-1.amazonaws.com
#   docker tag transaction-validator:1.0.0 ACCOUNT.dkr.ecr.us-east-1.amazonaws.com/transaction-validator:1.0.0
#   docker push ACCOUNT.dkr.ecr.us-east-1.amazonaws.com/transaction-validator:1.0.0

